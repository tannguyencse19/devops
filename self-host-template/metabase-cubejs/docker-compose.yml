services:
  metabase:
    image: metabase/metabase:latest
    container_name: metabase
    restart: unless-stopped
    ports:
      - "5700:3000"
    environment:
      # Coolify will provide FQDN for external access
      - SERVICE_FQDN_METABASE
      # Database configuration - using Coolify variables
      - MB_DB_TYPE=postgres
      - MB_DB_DBNAME=${POSTGRES_DATABASE:-metabase}
      - MB_DB_PORT=5432
      - MB_DB_USER=${POSTGRES_USER:-metabase}
      - MB_DB_PASS=${SERVICE_PASSWORD_POSTGRES}
      - MB_DB_HOST=postgres
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    volumes:
      - metabase-data:/plugins
    labels:
      - coolify.managed=true

  postgres:
    image: postgres:15-alpine
    container_name: metabase_postgres
    restart: unless-stopped
    ports:
      - "5710:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DATABASE:-metabase}
      - POSTGRES_USER=${POSTGRES_USER:-metabase}
      - POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRES}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DATABASE}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - coolify.managed=true

  cube:
    image: cubejs/cube
    ports:
      - "5720:4000"
    environment:
      - CUBEJS_DEV_MODE=true
      - CUBEJS_DB_TYPE=postgres
      - CUBEJS_DB_HOST=postgres
      - CUBEJS_DB_PORT=5432
      - CUBEJS_DB_NAME=${POSTGRES_DATABASE:-metabase}
      - CUBEJS_DB_USER=${POSTGRES_USER:-metabase}
      - CUBEJS_DB_PASS=${SERVICE_PASSWORD_POSTGRES}
      - CUBEJS_API_SECRET=eb70d75310a4e38da004019f45364f7bed0749e139881104fab93568c0f920ff
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - cube-conf:/cube/conf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5720/readyz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - coolify.managed=true

volumes:
  metabase-data:
    driver: local
  postgres-data:
    driver: local
  cube-conf:
    driver: local

networks:
  default:
    name: metabase-network