# Metabase Coolify Application Deployment

Complete setup for deploying Metabase analytics platform to Coolify using Docker Compose APPLICATION.

## What's Included

- **docker-compose.yml** - Coolify-optimized compose configuration
- **.example.env** - Environment variables template with Coolify integration
- **INSTALL.sh** - Deployment guide and API verification
- **UNINSTALL.sh** - Application removal guide
- **VERIFY.sh** - Deployment status checker

## Architecture

### Services
- **Metabase**: Analytics and business intelligence platform
- **PostgreSQL**: Database backend for Metabase metadata

### Coolify Integration
- Uses `SERVICE_FQDN_METABASE` for external access routing
- Auto-generated `SERVICE_PASSWORD_POSTGRES` for database security
- No external port mappings - Coolify handles all routing
- Persistent data via Docker volumes


## Manual Deployment Steps

Since Coolify requires manual APPLICATION creation, follow these detailed steps:

### Step 1: Access Coolify Dashboard
1. Navigate to: `https://coolify.timothynguyen.work`
2. Login with admin credentials

### Step 2: Create New APPLICATION
1. Go to your Project
2. Click "Create New Resource"
3. Select "Applications" → "Docker Compose Empty"
4. Configure:
   - **Name**: `metabase`
   - **Description**: `Metabase Analytics Platform`

### Step 3: Configure Docker Compose
1. Copy content from `docker-compose.yml`
2. Paste into Coolify's Docker Compose editor
3. Coolify will automatically:
   - Generate `SERVICE_PASSWORD_POSTGRES`
   - Create `SERVICE_FQDN_METABASE` for routing
   - Handle volume management

### Step 4: Environment Variables
Required variables (with defaults):
- `POSTGRES_DATABASE=metabase`
- `POSTGRES_USER=metabase`

Auto-generated by Coolify:
- `SERVICE_PASSWORD_POSTGRES` - Database password
- `SERVICE_FQDN_METABASE` - External access URL

### Step 5: Deploy
1. Click "Deploy" in Coolify
2. Monitor deployment progress
3. Wait for health checks to pass

## Environment Variables

### Database Configuration
```bash
POSTGRES_DATABASE=metabase    # Database name
POSTGRES_USER=metabase       # Database user
```

### Coolify Magic Variables
```bash
SERVICE_FQDN_METABASE        # Auto-generated external URL
SERVICE_PASSWORD_POSTGRES    # Auto-generated database password
```

## File Structure

```
vps/ci-cd/metabase/
├── docker-compose.yml          # Coolify-adapted compose file
├── .example.env               # Environment template
├── INSTALL.sh                 # Deployment guide
├── UNINSTALL.sh              # Removal guide
├── VERIFY.sh                 # Status checker
└── README.md                 # This documentation
```

## Key Differences from Self-Host Setup

| Feature | Self-Host | Coolify APPLICATION |
|---------|-----------|-------------------|
| Port Access | Direct (5700:3000) | Via SERVICE_FQDN |
| Database Password | Manual .env | Auto-generated |
| SSL/TLS | Manual setup | Automatic via Coolify |
| Domain Management | Manual | Automatic via Coolify |
| Container Management | Direct docker compose | Via Coolify UI |

## Health Checks

### Metabase Service
- **Endpoint**: `http://localhost:3000/api/health`
- **Interval**: 30 seconds
- **Startup**: 5 minutes allowed

### PostgreSQL Service  
- **Command**: `pg_isready -U metabase -d metabase`
- **Interval**: 10 seconds
- **Startup**: 30 seconds allowed

## Data Persistence

All data is stored in Docker volumes managed by Coolify:
- `metabase-data` - Metabase plugins and configurations
- `postgres-data` - PostgreSQL database files

## Troubleshooting

### Check Application Status
```bash
./VERIFY.sh
```

### View Logs
Access logs via Coolify dashboard:
1. Go to your Metabase application
2. Click "Logs" tab
3. Select service (metabase/postgres)

### Common Issues

**Application won't start:**
- Check environment variables in Coolify UI
- Verify docker-compose.yml syntax
- Review health check logs

**Database connection failed:**
- Ensure PostgreSQL container is healthy
- Check `SERVICE_PASSWORD_POSTGRES` is set
- Verify network connectivity between services

**External access issues:**
- Confirm `SERVICE_FQDN_METABASE` is configured
- Check Coolify proxy settings
- Verify domain DNS resolution

## Security Notes

- Database password auto-generated by Coolify
- No hardcoded credentials in configuration files
- Internal service communication only
- External access controlled by Coolify proxy

## Uninstallation

To remove the application:

```bash
./UNINSTALL.sh
```

**Warning**: This will permanently delete all Metabase data including dashboards, users, and database content.

## Support and Resources

- **Coolify Documentation**: https://coolify.io/docs
- **Metabase Documentation**: https://www.metabase.com/docs
- **Coolify Dashboard**: https://coolify.timothynguyen.work
- **API Endpoints**: Check VERIFY.sh for available endpoints

## Version Information

- **Metabase**: Latest (automatically updated)
- **PostgreSQL**: 15-alpine
- **Coolify Compatibility**: v4.x+